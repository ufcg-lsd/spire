Agent plugin: SVIDStore "scone"

The scone SVID Store plugin uses the selectors `cas_session_name` and `cas_session_hash` in entries of the SVID Store type (`svidstore:type:scone_cas_secretsmanager`) to post SVIDs in the SCONE CAS secret store.

The plugin posts sessions with the constraints specified in the selectors to ensure that only attested workloads will get access to the right SVIDs. To ensure that it is posting secrets in an attested and trusted CAS instance, the plugin relies on the CA trusted anchor certificate for that CAS instance. This certificate is extracted from the file `~/cas/config.json` created by the SCONE CLI after the execution of the `scone cas attest` command. The trust anchor is the first certificate of the certificate chain written in the file.

The plugin uses session templates to give operator more flexibility. Each template has placeholders used by the plugin to inject information and constraints for access control in the secret store.

> To learn more about CAS and LAS, how to use a public and deploy LAS locally, go to the [SCONE documentation](https://sconedocs.github.io/CASOverview/).

> :information_source: It's recommended to use [CAS namespaces](https://sconedocs.github.io/namespace/).

> :warning: The plugin can recover from most failure cases related to the session's predecessor management (ex., crashed agent, restarted CAS, CAS temporary unavailability). Despite this, when the plugin looses the local predecessor for an existing session in CAS, the plugin can not recover. 

The configuration fields are:

| Configuration | Description |
| ------------- | ----------- |
| `cas_address` | CAS address including protocol and port. |
| `cas_client_certificate` | Path to the certificate that should be used in the communications with CAS. |
| `cas_client_key` | Path to the key of the certificate configured in `cas_client_certificate`. |
| `cas_predecessor_dir` | Directory where the plugin should keep the predecessor hashes for each session it is maintaining at CAS. If the directory does not exist, it is created. |
| `svid_session_template_file` | Path to the SVID session template that the plugin should use. |
| `ca_bundle_session_template_file` | Path to the CA session template that the plugin should use. |
| `federated_bundles_session_template_file` | Path to the federated bundles session template that the plugin should use. |
| `trust_anchor_certificate` | Path to the CAS trust anchor certificate extracted from the `~/.cas/config.json` generated by the SCONE CLI after attesting the CAS instance |

The selectors are:

| Selector | Value |
| -------- | ----- |
| `svidstore:type`   | `scone_cas_secretsmanager` |
| `cas_session_name` | Session name posted in the CAS with the initial workload configuration |
| `cas_session_hash` | Hash digest of the session passed in the `cas_session_name` selector |

The placeholders needed by the plugin for each session are:

| Session | Placeholders | Description |
| ------- | ------------ | ----------- | 
|  SVID session template         | `${predecessor}` | Used to inject the predecessor value. |
| * | `${session-name-selector}` | Used to inject the session name authorized to import the SVID. Same as the name in the selector `cas_session_name`. |
| * | `${session-hash-selector}` | Used to inject the hash of the session authorized to import the SVID. Same as the hash in the selector `cas_session_hash`. |
| * | `${svid}` | Used to inject the SVID in PEM format. |
| * | `${svid-key}` | Used to inject the SVID key in PEM format. |
|  CA session template                  | `${predecessor}` | Used to inject the predecessor value. |
| * | `${trust-bundle-ca}`              | Used to inject the trust bundle bundle CA in PEM format. |
|  Federated bundles session template   | `${predecessor}` | Used to inject the predecessor value. |
| * | `${trust-bundle-ca}` | Used to inject the trust bundles in PEM format. |

# Configuration Example

```
SVIDStore "scone_cas_secretsmanager" {
  plugin_data {
      cas_address = "https://5-1-0.scone-cas.cf:8082"
      cas_client_certificate = "/home/ubuntu/cas/session.crt"
      cas_client_key = "/home/ubuntu/cas/session.key"
      cas_predecessor_dir = "./data/predecessors"
      svid_session_template_file = "/home/ubuntu/cas/svid_session_template.yaml"
      ca_bundle_session_template_file = "/home/ubuntu/cas/ca_session_template.yaml"
      federated_bundles_session_template_file = "/home/ubuntu/cas/fed_bundles_session_template.yaml"
    }
}
```

# Session File Examples

SVID session template:

```yaml
name: example-namespace/spire-svid-${session-name-selector}
version: "0.3"
predecessor: ${predecessor}
secrets:
  - name: svid
    kind: x509
    value: |
        ${svid}

    export:
        session: ${session-name-selector}
        session_hash: ${session-hash-selector}
    private_key: svid_key
  - name: svid_key
    kind: private-key
    export:
        session: ${session-name-selector}
        session_hash: ${session-hash-selector}
    value: |
        ${svid-key}
```

CA session template:

```yaml
name: spire-ca
version: "0.3"
predecessor: ${predecessor}
secrets:
  - name: spire-ca
    kind: x509-ca
    export_public: true
    value: |
        ${trust-bundle-ca}
```

Federated bundles session template:

```yaml
name: spire-federated-bundles
version: "0.3"
predecessor: ${predecessor}
secrets:
  - name: spire-federated-bundles
    kind: x509-ca
    export_public: true
    value: |
        ${trust-bundle-ca}
```

# Supported SCONE Versions

- SCONE 5.2.0
